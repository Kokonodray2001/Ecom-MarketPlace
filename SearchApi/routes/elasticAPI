require('dotenv').config()
var express = require('express');
var router = express.Router();
const { Client } = require('@elastic/elasticsearch')
    

    //connect to client api
    const client = new Client({
        cloud: { id: 'searchService-ES:dXMtY2VudHJhbDEuZ2NwLmNsb3VkLmVzLmlvJDBiZjUxMTk3YWQxMTRkNmQ4MDBlZWFkZTg5NjFkMjQ5JGZjMzM4ZDA3ZGNhMzRiOGZhNDY0ZTQ5YmUyYTIwZGQz' },
        auth: { apiKey: process.env.apiKey }
      })

async function run1 (req,res,next) {

  console.log(process.env.apiKey);
    //Let's search!
    try {
         // here we are forcing an index refresh, otherwise we will not
    // get any result in the consequent search
        await client.indices.refresh({ index: 'search-store-details' })
        const searchQuery =  req.body.query;
        console.log(searchQuery)
        const result= await client.search({
          index: 'search-store-details',
          body: {
            query: {
                match_phrase_prefix: {
                    storeName: searchQuery
                }
            }
        }
        })
      
        res.send(result.hits.hits);
        next();
      
    } catch (error) {
        res.send(error);    
        next();
    }

 }
 async function run2 (req,res,next) {

  console.log(process.env.apiKey);
    //Let's search!
    try {
         // here we are forcing an index refresh, otherwise we will not
    // get any result in the consequent search
        await client.indices.refresh({ index: 'search-store-details' })
        const result = await client.search({
          index: 'search-store-details',
          body: {
              query: {
                  match_all: {}
              }
          }
      });
        res.send(result.hits.hits);
        next();
      
    } catch (error) {
        res.send(error);    
        next();
    }

 }

router.post('/searchResult',run1,(req, res) =>{
  console.log("response sent")
  
});
router.get('/getAll',run2,(req,res)=>{
    console.log("hello");
    
})
module.exports = router;
